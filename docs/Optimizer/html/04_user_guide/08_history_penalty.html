

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Historical penalties &mdash; optimizer 1.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/qb1-sphinx-rtd.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme-overrides.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/optimizer.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Adaptive Differential Evolution example" href="09_adaptive_differential_evolution.html" />
    <link rel="prev" title="Optimization diagnostic" href="07_diagnostic.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> optimizer
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../01_introduction/01_introduction.html">What is Optimizer?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_introduction/01_introduction.html#using-optimizer">Using Optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_introduction/01_introduction.html#is-optimizer-right-for-my-problem">Is Optimizer right for my problem?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_introduction/01_introduction.html#assumptions">Assumptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_introduction/01_introduction.html#faq">FAQ</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../02_getting_started/01_prerequisites.html">Installation prerequisites</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../02_getting_started/01_prerequisites.html#python-virtual-environments">Python virtual environments</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../02_getting_started/01_prerequisites.html#using-conda">Using <code class="docutils literal notranslate"><span class="pre">conda</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../02_getting_started/01_prerequisites.html#installing-requirements">Installing requirements</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../02_getting_started/02_install.html">Installation guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../03_tutorial/01_solver_api.html">Solver API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../03_tutorial/01_solver_api.html#ask-and-tell-pattern">Ask and Tell pattern</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../03_tutorial/01_solver_api.html#standard-solve-pattern">Standard solve pattern</a></li>
<li class="toctree-l3"><a class="reference internal" href="../03_tutorial/01_solver_api.html#solving-with-ask-and-tell">Solving with Ask and Tell</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../03_tutorial/01_solver_api.html#further-reading">Further reading</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../03_tutorial/02_toy_problem.html">Toy problem</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../03_tutorial/02_toy_problem.html#The-Solver">The Solver</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../03_tutorial/02_toy_problem.html#ask-method"><code class="docutils literal notranslate"><span class="pre">ask</span></code> method</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../03_tutorial/02_toy_problem.html#Evaluating">Evaluating</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../03_tutorial/02_toy_problem.html#tell-method"><code class="docutils literal notranslate"><span class="pre">tell</span></code> method</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../03_tutorial/02_toy_problem.html#Solver-loop">Solver loop</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../03_tutorial/03_constraints.html">Constraints</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../03_tutorial/03_constraints.html#Constraints-as-penalty-functions">Constraints as penalty functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_tutorial/03_constraints.html#Constraints-as-repair-functions">Constraints as repair functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_tutorial/03_constraints.html#Warning-about-pickling-constraints">Warning about pickling constraints</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../03_tutorial/04_optimization_problem.html">Optimization problem</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../03_tutorial/04_optimization_problem.html#Maximizing-a-problem">Maximizing a problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_tutorial/04_optimization_problem.html#The-StatefulOptimizationProblem">The <code class="docutils literal notranslate"><span class="pre">StatefulOptimizationProblem</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../03_tutorial/04_optimization_problem.html#StatefulOptimizationProblem-with-Numpy"><code class="docutils literal notranslate"><span class="pre">StatefulOptimizationProblem</span></code> with <code class="docutils literal notranslate"><span class="pre">Numpy</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../03_tutorial/04_optimization_problem.html#StatefulOptimizationProblem-with-Pandas"><code class="docutils literal notranslate"><span class="pre">StatefulOptimizationProblem</span></code> with <code class="docutils literal notranslate"><span class="pre">Pandas</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="01_penalty.html">Penalty</a><ul>
<li class="toctree-l2"><a class="reference internal" href="01_penalty.html#Constraint-types">Constraint types</a></li>
<li class="toctree-l2"><a class="reference internal" href="01_penalty.html#Equality-constraints">Equality constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="01_penalty.html#Model-based-constraints">Model-based constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="01_penalty.html#Dealing-with-a-computationally-expensive-constraint">Dealing with a computationally expensive constraint</a></li>
<li class="toctree-l2"><a class="reference internal" href="01_penalty.html#Penalty-options">Penalty options</a></li>
<li class="toctree-l2"><a class="reference internal" href="01_penalty.html#Changing-the-penalty-multiplier-(\lambda)">Changing the penalty multiplier (<span class="math notranslate nohighlight">\(\lambda\)</span>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="01_penalty.html#Set-based-constraints">Set-based constraints</a><ul>
<li class="toctree-l3"><a class="reference internal" href="01_penalty.html#A-comment-on-set-constraints:">A comment on set constraints:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="02_repair.html">Repair</a><ul>
<li class="toctree-l2"><a class="reference internal" href="02_repair.html#MultipleOf-and-Integer-constraints"><code class="docutils literal notranslate"><span class="pre">MultipleOf</span></code> and <code class="docutils literal notranslate"><span class="pre">Integer</span></code> constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_repair.html#User-defined-set-constraints">User defined set constraints</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="03_solver.html">Solver</a><ul>
<li class="toctree-l2"><a class="reference internal" href="03_solver.html#basesolver"><code class="docutils literal notranslate"><span class="pre">BaseSolver</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="03_solver.html#scaledsolver"><code class="docutils literal notranslate"><span class="pre">ScaledSolver</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="03_solver.html#differentialevolutionsolver"><code class="docutils literal notranslate"><span class="pre">DifferentialEvolutionSolver</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="03_solver.html#evolutionarystrategiessolver"><code class="docutils literal notranslate"><span class="pre">EvolutionaryStrategiesSolver</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="03_solver.html#particleswarmsolver"><code class="docutils literal notranslate"><span class="pre">ParticleSwarmSolver</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="03_solver.html#simulatedannealingsolver"><code class="docutils literal notranslate"><span class="pre">SimulatedAnnealingSolver</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="03_solver.html#discretelocalsearchsolver"><code class="docutils literal notranslate"><span class="pre">DiscreteLocalSearchSolver</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="04_stopper.html">Stoppers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="04_stopper.html#noimprovementstopper"><code class="docutils literal notranslate"><span class="pre">NoImprovementStopper</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="04_stopper.html#walltimestopper"><code class="docutils literal notranslate"><span class="pre">WallTimeStopper</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="04_stopper.html#satisfiedconstraintstopper"><code class="docutils literal notranslate"><span class="pre">SatisfiedConstraintStopper</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="05_logger.html">Logger</a><ul>
<li class="toctree-l2"><a class="reference internal" href="05_logger.html#basiclogger"><code class="docutils literal notranslate"><span class="pre">BasicLogger</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="05_logger.html#penaltylogger"><code class="docutils literal notranslate"><span class="pre">PenaltyLogger</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="05_logger.html#nbestlogger"><code class="docutils literal notranslate"><span class="pre">NBestLogger</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="05_logger.html#file-based-logging">File-Based Logging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="06_plotting.html">Plotting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="06_plotting.html#Convergence-plot">Convergence plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="06_plotting.html#Penalty-plot">Penalty plot</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="07_diagnostic.html">Optimization diagnostic</a><ul>
<li class="toctree-l2"><a class="reference internal" href="07_diagnostic.html#Overview">Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="07_diagnostic.html#What-this-is">What this is</a></li>
<li class="toctree-l3"><a class="reference internal" href="07_diagnostic.html#What-this-is-not">What this is not</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="07_diagnostic.html#The-optimization-model">The optimization model</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_diagnostic.html#The-diagnostic">The diagnostic</a><ul>
<li class="toctree-l3"><a class="reference internal" href="07_diagnostic.html#Violated-soft-constraints">Violated soft constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="07_diagnostic.html#Changing-the-inequality-bound">Changing the inequality bound</a></li>
<li class="toctree-l3"><a class="reference internal" href="07_diagnostic.html#Impact-we-can-achieve-on-objective-value-by-changing-inequality">Impact we can achieve on objective value by changing inequality</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="07_diagnostic.html#Extrapolation-pitfall">Extrapolation pitfall</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_diagnostic.html#Complex-problem-support">Complex problem support</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_diagnostic.html#Conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Historical penalties</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Overview">Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#What-this-is">What this is</a></li>
<li class="toctree-l3"><a class="reference internal" href="#What-this-is-not">What this is not</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#The-historical-data-and-the-optimization-problem">The historical data and the optimization problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Using-the-historical-penalty">Using the historical penalty</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Validating-that-history-is-constraining-our-solutions">Validating that history is constraining our solutions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Choosing-the-multiplier">Choosing the multiplier</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Pandas-support">Pandas support</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Pipeline-support">Pipeline support</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="09_adaptive_differential_evolution.html">Adaptive Differential Evolution example</a><ul>
<li class="toctree-l2"><a class="reference internal" href="09_adaptive_differential_evolution.html#Vanilla-DE-logic">Vanilla DE logic</a></li>
<li class="toctree-l2"><a class="reference internal" href="09_adaptive_differential_evolution.html#What-can-we-define-and-tune?">What can we define and tune?</a></li>
<li class="toctree-l2"><a class="reference internal" href="09_adaptive_differential_evolution.html#Adaptive-Differential-Evolution">Adaptive Differential Evolution</a><ul>
<li class="toctree-l3"><a class="reference internal" href="09_adaptive_differential_evolution.html#Some-setup">Some setup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="09_adaptive_differential_evolution.html#Sample-run-of-two-approaches">Sample run of two approaches</a></li>
<li class="toctree-l2"><a class="reference internal" href="09_adaptive_differential_evolution.html#Picking-mutator-based-on-prior-success">Picking mutator based on prior success</a></li>
<li class="toctree-l2"><a class="reference internal" href="09_adaptive_differential_evolution.html#Using-an-adaptive-parameter">Using an adaptive parameter</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="09_adaptive_differential_evolution.html#Happy-hacking!">Happy hacking!</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../05_examples/warm_start.html">Warm start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../05_examples/warm_start.html#Problem-setup">Problem setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_examples/warm_start.html#Warm-starting-ParticleSwarmSolver">Warm starting <code class="docutils literal notranslate"><span class="pre">ParticleSwarmSolver</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../05_examples/de_hyperparameters.html">Tuning differential evolution hyperparameters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../05_examples/de_hyperparameters.html#Setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_examples/de_hyperparameters.html#Effect-of-strategy">Effect of <code class="docutils literal notranslate"><span class="pre">strategy</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_examples/de_hyperparameters.html#Effect-of-popsize">Effect of <code class="docutils literal notranslate"><span class="pre">popsize</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_examples/de_hyperparameters.html#Effect-of-mutation">Effect of <code class="docutils literal notranslate"><span class="pre">mutation</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_examples/de_hyperparameters.html#Effect-of-recombination">Effect of <code class="docutils literal notranslate"><span class="pre">recombination</span></code></a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../06_optimizer_api/modules.html">optimizer</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../06_optimizer_api/optimizer.html">optimizer package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../06_optimizer_api/optimizer.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../06_optimizer_api/optimizer.constraint.html">optimizer.constraint package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../06_optimizer_api/optimizer.experimental.html">optimizer.experimental package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../06_optimizer_api/optimizer.loggers.html">optimizer.loggers package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../06_optimizer_api/optimizer.plotting.html">optimizer.plotting package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../06_optimizer_api/optimizer.problem.html">optimizer.problem package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../06_optimizer_api/optimizer.solvers.html">optimizer.solvers package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../06_optimizer_api/optimizer.stoppers.html">optimizer.stoppers package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../06_optimizer_api/optimizer.testing.html">optimizer.testing package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../06_optimizer_api/optimizer.utils.html">optimizer.utils package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../06_optimizer_api/optimizer.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../06_optimizer_api/optimizer.html#module-optimizer.exceptions">optimizer.exceptions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../06_optimizer_api/optimizer.html#module-optimizer.types">optimizer.types module</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">optimizer</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          








    



    
















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Historical penalties</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <!-- User defined GitHub URL -->
              <a href="https://git.mckinsey-solutions.com/opm/optimus" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">optimizer.constraint</span> <span class="kn">import</span> <span class="n">history_penalty</span>
<span class="kn">from</span> <span class="nn">optimizer.loggers</span> <span class="kn">import</span> <span class="n">BestTrajectoryLogger</span>
<span class="kn">from</span> <span class="nn">optimizer.plotting</span> <span class="kn">import</span> <span class="n">best_trajectory_plot</span>

<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">optimus_pkg.core.transformers</span> <span class="kn">import</span> <span class="n">SelectColumns</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Historical-penalties">
<h1>Historical penalties<a class="headerlink" href="#Historical-penalties" title="Permalink to this headline">¶</a></h1>
<p>A walkthrough on how to navigate the trade-off between keeping the solutions close to historical ranges and allowing the optimizer to explore a broader space.</p>
<div class="section" id="Overview">
<h2>Overview<a class="headerlink" href="#Overview" title="Permalink to this headline">¶</a></h2>
<p>There are cases when pushing the boundaries of the current operational paradigm is the right thing to do, while in other cases we prefer to prioritize getting the buy-in from operators. In this tutorial we’ll explore balancing this trade-off in a continuous manner: we’ll be able to explicitly say how much we want our optimizer to stick to historical ranges.</p>
<div class="section" id="What-this-is">
<h3>What this is<a class="headerlink" href="#What-this-is" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>A tutorial on how to balanace historical preferences vs.&nbsp;exploring a broader search space</li>
</ul>
</div>
<div class="section" id="What-this-is-not">
<h3>What this is not<a class="headerlink" href="#What-this-is-not" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>A guide into optimization algorithms and their tuning</li>
<li>A guide into how to properly set-up an optimization problem (penalty tuning, repair functions, etc)</li>
<li>A real world optimizer use case</li>
<li>A guide on how to read diagnostics of an optimization run</li>
</ul>
</div>
</div>
<div class="section" id="The-historical-data-and-the-optimization-problem">
<h2>The historical data and the optimization problem<a class="headerlink" href="#The-historical-data-and-the-optimization-problem" title="Permalink to this headline">¶</a></h2>
<p>Consider the following 2-dimensional problem in which we want to maximize <span class="math notranslate nohighlight">\(x+y\)</span> subject to <span class="math notranslate nohighlight">\((x,y)\)</span> being close to historical values. Each coordinate is also bounded between <span class="math notranslate nohighlight">\(-4\)</span> and <span class="math notranslate nohighlight">\(4\)</span>. This translates to the following problem:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
\max \quad &amp; x + y \\
\text{s.t.} \quad &amp; \text{(x,y) is close to historical ranges} \\
&amp; -4 \leq x,y \leq 4
\end{align*}\end{split}\]</div>
<p>The figure below shows historical data, indicating the direction in which the objective function is increasing.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Generate fancy shape data</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="n">X1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mf">1.3</span><span class="p">,</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">6</span>
<span class="n">X2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">01</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">width</span><span class="o">=.</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;Objective value grows in this direction&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-.</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;We&#39;d expect OPT to be around here&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Historical (x,y) points&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/04_user_guide_08_history_penalty_3_0.png" src="../_images/04_user_guide_08_history_penalty_3_0.png" />
</div>
</div>
</div>
<div class="section" id="Using-the-historical-penalty">
<h2>Using the historical penalty<a class="headerlink" href="#Using-the-historical-penalty" title="Permalink to this headline">¶</a></h2>
<p>The idea is to use an anomaly detection score to penalize solutions that are far from historical regions during the optimization. This will act as any other penalty during the optimization phase. Let’s create this penalty and plot the payments we’ll incurr in our search space.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># We create the penalty by passing the historical values to outlier_penalty</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">history_penalty</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="c1"># How this penalty penalizes the regions</span>
<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Penalty payments&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/04_user_guide_08_history_penalty_6_0.png" src="../_images/04_user_guide_08_history_penalty_6_0.png" />
</div>
</div>
<p>Let’s also make a contour plot of the penalized objective function, that is: objective function - penalties.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mesh_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">mesh_xy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">mesh_xy</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">(</span><span class="n">mesh_xy</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;f.obj - penalty: The penalty has almost no effect&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">();</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-.</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/04_user_guide_08_history_penalty_8_0.png" src="../_images/04_user_guide_08_history_penalty_8_0.png" />
</div>
</div>
<p>We <strong>need</strong> to penalize more, since the payment we’re currently making in the worst case scenario is only <span class="math notranslate nohighlight">\(0.28\)</span>, while the objective function can take values up to <span class="math notranslate nohighlight">\(8\)</span>. That is, the magnitude of our objective function is much bigger. Let’s re-fit the penalty with a higher <code class="docutils literal notranslate"><span class="pre">penalty_multiplier</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># We create the penalty by passing the historical values to outlier_penalty</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">history_penalty</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">penalty_multiplier</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

<span class="n">Z</span> <span class="o">=</span> <span class="n">mesh_xy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">mesh_xy</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">(</span><span class="n">mesh_xy</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;f.obj - penalty with a reasonable multiplier&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-.</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/04_user_guide_08_history_penalty_10_0.png" src="../_images/04_user_guide_08_history_penalty_10_0.png" />
</div>
</div>
<p>This makes more sense, we plotted the red dot in where we’d expect to see the optimal value. Let us run the optimization and analyze the solution we get.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Set up an optimization problem and check how it behaves</span>
<span class="kn">from</span> <span class="nn">optimizer.solvers</span> <span class="kn">import</span> <span class="n">ParticleSwarmSolver</span>

<span class="n">sols</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">penalties</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>

    <span class="n">solver</span> <span class="o">=</span> <span class="n">ParticleSwarmSolver</span><span class="p">(</span>
        <span class="n">bounds</span><span class="p">,</span>
        <span class="n">sense</span><span class="o">=</span><span class="s2">&quot;maximize&quot;</span><span class="p">,</span>
        <span class="n">popsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
        <span class="n">maxiter</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">init</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">,</span>
        <span class="n">cognitive_parameter</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
        <span class="n">inertia</span><span class="o">=</span><span class="mf">0.2</span>
    <span class="p">)</span>

    <span class="n">best_trajectory_logger</span> <span class="o">=</span> <span class="n">BestTrajectoryLogger</span><span class="p">()</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">solver</span><span class="o">.</span><span class="n">stop</span><span class="p">():</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">ask</span><span class="p">()</span>
        <span class="n">objective_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">p</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">penalties</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">tell</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">objective_values</span><span class="p">)</span>
        <span class="n">sols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">best</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">best_trajectory_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best solution: </span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">Best objective: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">best</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">best_trajectory_plot</span><span class="p">(</span><span class="n">best_trajectory_logger</span><span class="p">,</span> <span class="n">penalties</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">variable_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]);</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>

<span class="n">solve</span><span class="p">([</span><span class="n">p</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">p</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">sx</span><span class="p">,</span><span class="n">sy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sols</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">prevx</span><span class="p">,</span> <span class="n">prevy</span> <span class="o">=</span> <span class="n">sols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">prevx</span><span class="p">,</span> <span class="n">prevy</span><span class="p">,</span> <span class="n">sx</span><span class="o">-</span><span class="n">prevx</span><span class="p">,</span> <span class="n">sy</span><span class="o">-</span><span class="n">prevy</span><span class="p">,</span> <span class="n">width</span><span class="o">=.</span><span class="mi">02</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">prevx</span><span class="p">,</span> <span class="n">prevy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">width</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;Objective value grows in this direction&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="o">-.</span><span class="mi">15</span><span class="p">]);</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Optimization trace in black dots, in red the payments we make&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best solution: [ 2.35640496 -0.41902119]

Best objective: 1.9373837700246597
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/04_user_guide_08_history_penalty_12_1.png" src="../_images/04_user_guide_08_history_penalty_12_1.png" />
</div>
</div>
<p>The black arrows represent the evolution of the best solution provided by the algorithm. We see it converges towards <span class="math notranslate nohighlight">\((2.55, -0.55)\)</span>, close to where we thought it would be – this optimization is history guided!</p>
<div class="section" id="Validating-that-history-is-constraining-our-solutions">
<h3>Validating that history is constraining our solutions<a class="headerlink" href="#Validating-that-history-is-constraining-our-solutions" title="Permalink to this headline">¶</a></h3>
<p>In real life we have more dimensions and cannot plot this, but we can use optimization diagnostic tools! Take a look at the optimization diagnostic tutorial, or just take a peak on how the solve function calls <code class="docutils literal notranslate"><span class="pre">best_trajectory_plot</span></code> and uses the <code class="docutils literal notranslate"><span class="pre">best_trajectory_logger</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">solve</span><span class="p">([</span><span class="n">p</span><span class="p">],</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best solution: [ 2.35640496 -0.41902119]

Best objective: 1.9373837700246597
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/04_user_guide_08_history_penalty_15_1.png" src="../_images/04_user_guide_08_history_penalty_15_1.png" />
</div>
</div>
<p>We see here that the <code class="docutils literal notranslate"><span class="pre">history_penalty</span></code> slack is dark blue, that is, there’s not much room to move further away from history and not incur a penalty. This means that the historical constraint is limiting us from increasing the objective, <span class="math notranslate nohighlight">\(x+y\)</span>.</p>
</div>
<div class="section" id="Choosing-the-multiplier">
<h3>Choosing the multiplier<a class="headerlink" href="#Choosing-the-multiplier" title="Permalink to this headline">¶</a></h3>
<p>Optimization diagnostic tools can help determine an appropriate penalty multiplier: if the multiplier is very low, the cost of violating the <code class="docutils literal notranslate"><span class="pre">history_penalty</span></code> is so low that the optimizer will just pay and violate it – we can detect this behavior on the diagnostic report. Consider the following diagnostic plot - we’ve set the penalty multiplier quite low and our optimizer is willingly incurring large penalties as a result.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">p</span> <span class="o">=</span> <span class="n">history_penalty</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">penalty_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">solve</span><span class="p">([</span><span class="n">p</span><span class="p">],</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best solution: [4. 4.]

Best objective: 7.776461804999271
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/04_user_guide_08_history_penalty_17_1.png" src="../_images/04_user_guide_08_history_penalty_17_1.png" />
</div>
</div>
</div>
<div class="section" id="Pandas-support">
<h3>Pandas support<a class="headerlink" href="#Pandas-support" title="Permalink to this headline">¶</a></h3>
<p>We can use a Pandas DataFrame out of the box</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>
<span class="n">df_penalty</span> <span class="o">=</span> <span class="n">history_penalty</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="n">df_penalty</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="n">alpha</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Paying for anomalies in a DataFrame&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/04_user_guide_08_history_penalty_19_0.png" src="../_images/04_user_guide_08_history_penalty_19_0.png" />
</div>
</div>
</div>
<div class="section" id="Pipeline-support">
<h3>Pipeline support<a class="headerlink" href="#Pipeline-support" title="Permalink to this headline">¶</a></h3>
<p>We might want/need to penalize being far from historical sources on a subset of columns, for example in situations where our predictive model is generating dynamic features/controls. We recommend leveraging <code class="docutils literal notranslate"><span class="pre">sklearn.pipeline.Pipeline</span></code> to achieve this, and if the transformers in the pipeline support <code class="docutils literal notranslate"><span class="pre">pd.DataFrame</span></code>, then we can leverage them to select subset of columns for the penalty function. This is useful, for example, when we have:</p>
<ul class="simple">
<li>a data frame with 60 columns that captures all the operation</li>
<li>we’re having trouble getting recommendations buy-in in some specific area of the operation (say, cyclones)</li>
<li>we can penalize only on the columns related to cyclones, which might have only 5 columns</li>
</ul>
<p>In the following example we select column <span class="math notranslate nohighlight">\(y\)</span> for detecting historical deviations only in that dimension</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s1">&#39;x_select&#39;</span><span class="p">,</span> <span class="n">SelectColumns</span><span class="p">([</span><span class="s1">&#39;y&#39;</span><span class="p">]))])</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="c1"># Pipeline has to be fit</span>


<span class="n">df_penalty</span> <span class="o">=</span> <span class="n">history_penalty</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="n">pipe</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="n">df_penalty</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="n">alpha</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Paying only for anomalies in y&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/04_user_guide_08_history_penalty_21_0.png" src="../_images/04_user_guide_08_history_penalty_21_0.png" />
</div>
</div>
</div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Found a bug, or didn’t find what you were looking for? <a class="reference external" href="https://git.mckinsey-solutions.com/opm/optimus/issues/new/choose">🙏Please file a
issue</a></p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="09_adaptive_differential_evolution.html" class="btn btn-neutral float-right" title="Adaptive Differential Evolution example" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="07_diagnostic.html" class="btn btn-neutral float-left" title="Optimization diagnostic" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, QuantumBlack

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>